<!DOCTYPE html>
<html>
<head>
  <title>PedalDash</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #87ceeb;
      overflow: hidden;
      user-select: none;
    }
    canvas {
      display: block;
      background: #cceeff;
    }
    #homeScreen, #gameOverScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #222;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    #slideBarContainer {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 30px;
      background: #ccc;
      border-radius: 15px;
      overflow: hidden;
      z-index: 11;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: transparent;
      user-select: none;
    }
    #greenBar {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 100%;
      background: linear-gradient(
        to right,
        transparent 0%,
        #3cba54 15%,
        #3cba54 40%,
        #d62828 40%,
        #d62828 60%,
        #3cba54 60%,
        #3cba54 85%,
        transparent 85%
      );
      z-index: 1;
    }
    #slider {
      position: absolute;
      top: 0; bottom: 0;
      width: 15%;
      background: rgba(255,255,255,0.8);
      animation: slide 2.5s linear infinite;
      z-index: 2;
      border-radius: 10px;
      box-shadow: 0 0 5px 2px rgba(255,255,255,0.6);
    }
    @keyframes slide {
      0% { left: 0; }
      100% { left: 85%; }
    }
    .floating-money {
      position: fixed;
      color: #3cba54;
      font-weight: bold;
      font-size: 48px;
      animation: popUp 1s ease forwards;
      pointer-events: none;
      user-select: none;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.6);
      text-shadow: 0 0 6px #1f6f26;
      z-index: 1000;
    }
    @keyframes popUp {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.6); }
      50% { opacity: 1; transform: translate(-50%, -80%) scale(1.1); }
      100% { opacity: 0; transform: translate(-50%, -120%) scale(1.4); }
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 10px;
      cursor: pointer;
    }
    input {
      padding: 8px;
      font-size: 18px;
      margin-top: 10px;
      width: 200px;
      text-align: center;
    }
    h2, h3 {
      margin: 5px 0;
    }
    #leaderboardsContainer {
      display: flex;
      justify-content: space-around;
      width: 80%;
      margin-top: 15px;
      flex-wrap: wrap;
      max-width: 700px;
    }
    .leaderboardBox {
      background: #333;
      padding: 10px;
      border-radius: 8px;
      margin: 5px;
      width: 300px;
      max-width: 90vw;
      color: white;
    }
    .leaderboardBox h3 {
      text-align: center;
      margin-bottom: 8px;
    }
    ol {
      padding-left: 20px;
    }
    #upgradeSection {
      margin-top: 15px;
      color: white;
      max-width: 300px;
      background: #333;
      border-radius: 8px;
      padding: 10px;
      user-select: none;
    }
    #upgradeSection button {
      margin-top: 5px;
      width: 100%;
      background: #3cba54;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="homeScreen">
    <h1>PedalDash</h1>
    <button onclick="startGame()">Play Speed Round</button>
    <input id="usernameInput" placeholder="Enter your name" maxlength="12" />
    <div id="upgradeSection">
      <h3>Bike Upgrades</h3>
      <div>Money Multiplier: <span id="moneyMultiplierDisplay">1.00x</span></div>
      <button id="upgrade10kBtn" onclick="buyUpgrade(10000)">+10% Money ($10,000)</button>
      <button id="upgrade100kBtn" onclick="buyUpgrade(100000)">+25% Money ($100,000)</button>
      <div id="upgradeMessage" style="color:yellow; margin-top: 5px; min-height: 20px;"></div>
    </div>
  </div>

  <div id="slideBarContainer">
    <div id="greenBar"></div>
    <div id="slider"></div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="gameOverScreen" style="display:none; z-index:20; flex-direction: column; align-items: center;">
    <h2>Game Over</h2>
    <div id="results"></div>
    <div id="leaderboardsContainer">
      <div class="leaderboardBox" id="worldMoneyLeaderboard">
        <h3>World Leaderboard - Money</h3>
        <ol id="worldMoneyList"></ol>
      </div>
      <div class="leaderboardBox" id="worldDeliveryLeaderboard">
        <h3>World Leaderboard - Packages</h3>
        <ol id="worldDeliveryList"></ol>
      </div>
      <div class="leaderboardBox" id="personalBestLeaderboard">
        <h3>Your Personal Best</h3>
        <p id="personalMoneyBest">$0</p>
        <p id="personalDeliveriesBest">0 deliveries</p>
      </div>
    </div>
    <button onclick="goHome()">Home</button>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const roadY = canvas.height - 150;
    const roadHeight = 150;
    const bike = { x: 50, y: roadY - 40, width: 60, height: 40 };

    let houses = [];
    let packages = [];
    let score = 0;
    let deliveries = 0;
    let gameTimer = 30;
    let animationFrameId = null;
    let timerIntervalId = null;
    let username = localStorage.getItem('username') || '';
    document.getElementById('usernameInput').value = username;

    let moneyMultiplier = parseFloat(localStorage.getItem('moneyMultiplier')) || 1;
    updateMoneyMultiplierDisplay();

    const slideBarContainer = document.getElementById('slideBarContainer');
    const slider = document.getElementById('slider');
    const homeScreen = document.getElementById('homeScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const resultsDiv = document.getElementById('results');
    const worldMoneyList = document.getElementById('worldMoneyList');
    const worldDeliveryList = document.getElementById('worldDeliveryList');
    const personalMoneyBest = document.getElementById('personalMoneyBest');
    const personalDeliveriesBest = document.getElementById('personalDeliveriesBest');
    const upgradeMessage = document.getElementById('upgradeMessage');
    const upgrade10kBtn = document.getElementById('upgrade10kBtn');
    const upgrade100kBtn = document.getElementById('upgrade100kBtn');

    function startGame() {
      username = document.getElementById('usernameInput').value.trim() || 'Player';
      localStorage.setItem('username', username);

      homeScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';
      slideBarContainer.style.display = 'flex';

      houses = [];
      packages = [];
      score = 0;
      deliveries = 0;
      gameTimer = 30;

      // Create houses with delivered flag
      for (let i = 0; i < 3; i++) {
        houses.push({ x: 400 + i * 450, y: roadY - 70, width: 80, height: 70, delivered: false });
      }

      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      if (timerIntervalId) clearInterval(timerIntervalId);

      timerIntervalId = setInterval(() => {
        gameTimer--;
        if (gameTimer <= 0) endGame();
      }, 1000);

      gameLoop();
      upgradeMessage.textContent = '';
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw road
      ctx.fillStyle = '#444';
      ctx.fillRect(0, roadY, canvas.width, roadHeight);

      // Draw houses & move left
      ctx.font = '48px serif';
      ctx.textBaseline = 'top';
      houses.forEach(h => {
        h.x -= 2;
        // Draw house emoji ðŸ¡
        ctx.fillText('ðŸ¡', h.x, h.y);
      });
      houses = houses.filter(h => h.x + h.width > 0);
      if (houses.length < 3) {
        const lastX = houses.length ? houses[houses.length - 1].x : 400;
        houses.push({ x: lastX + 450, y: roadY - 70, width: 80, height: 70, delivered: false });
      }

      // Draw bike mirrored emoji ðŸš²
      ctx.save();
      ctx.font = '48px serif';
      ctx.translate(bike.x + bike.width/2, bike.y + bike.height/2);
      ctx.scale(-1, 1); // mirror horizontally
      ctx.fillText('ðŸš²', -bike.width/2, -bike.height/2);
      ctx.restore();

      // Draw packages & move right (slower now)
      ctx.font = '28px serif';
      packages.forEach(p => {
        p.x += 2.5; // slower speed
        ctx.fillText('ðŸ“¦', p.x, p.y);
      });

      // Check package delivery, only one package per house and must be near
      packages = packages.filter(p => {
        for (const h of houses) {
          if (
            !h.delivered &&
            p.x > h.x && p.x < h.x + h.width &&
            p.y > h.y && p.y < h.y + h.height &&
            Math.abs(bike.x - h.x) < 150  // near enough bike to house to deliver
          ) {
            const baseTip = Math.floor(Math.random() * 10) + 10;
            const tip = Math.floor(baseTip * moneyMultiplier);
            showFloatingTip(tip);
            score += tip;
            deliveries++;
            h.delivered = true;
            return false; // remove package
          }
        }
        return p.x < canvas.width;
      });

      // HUD
      ctx.fillStyle = 'black';
      ctx.font = '20px Arial';
      ctx.fillText(`$${score}`, 20, 30);
      ctx.fillText(`Packages: ${deliveries}`, 20, 60);
      ctx.fillText(`Time: ${gameTimer}`, 20, 90);

      animationFrameId = requestAnimationFrame(gameLoop);
    }

    // Delivery on slider click
    canvas.addEventListener('click', () => {
      const barRect = slideBarContainer.getBoundingClientRect();
      const sliderRect = slider.getBoundingClientRect();
      const sliderCenter = sliderRect.left + sliderRect.width / 2;
      // Green zones are 15%-40% and 60%-85%, red zone is 40%-60%
      const greenZoneLeftStart = barRect.left + barRect.width * 0.15;
      const greenZoneLeftEnd = barRect.left + barRect.width * 0.40;
      const greenZoneRightStart = barRect.left + barRect.width * 0.60;
      const greenZoneRightEnd = barRect.left + barRect.width * 0.85;
      const redZoneStart = barRect.left + barRect.width * 0.40;
      const redZoneEnd = barRect.left + barRect.width * 0.60;

      // You must hit the red zone to throw package
      if (sliderCenter >= redZoneStart && sliderCenter <= redZoneEnd) {
        // Check if bike near any house that is not delivered
        let canDeliver = houses.some(h => !h.delivered && Math.abs(bike.x - h.x) < 150);
        if (canDeliver) {
          packages.push({ x: bike.x + bike.width, y: bike.y + bike.height / 2 });
          showUpgradeMessage('');
        } else {
          showUpgradeMessage("No houses nearby to deliver!");
        }
      } else {
        showUpgradeMessage("Timing must be in RED zone!");
      }
    });

    function showFloatingTip(amount) {
      const div = document.createElement('div');
      div.className = 'floating-money';
      div.innerText = `+$${amount}`;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 1000);
    }

    function endGame() {
      cancelAnimationFrame(animationFrameId);
      clearInterval(timerIntervalId);
      slideBarContainer.style.display = 'none';

      saveScore();

      resultsDiv.textContent = `${username}, you earned $${score} and delivered ${deliveries} packages.`;
      showLeaderboards();

      gameOverScreen.style.display = 'flex';
    }

    function goHome() {
      gameOverScreen.style.display = 'none';
      homeScreen.style.display = 'flex';
      upgradeMessage.textContent = '';
    }

    // Save and retrieve scores locally + stub for online
    function saveScore() {
      // Personal best tracking
      const personalBestMoney = +localStorage.getItem('personalBestMoney') || 0;
      const personalBestDeliveries = +localStorage.getItem('personalBestDeliveries') || 0;
      if (score > personalBestMoney) localStorage.setItem('personalBestMoney', score);
      if (deliveries > personalBestDeliveries) localStorage.setItem('personalBestDeliveries', deliveries);

      // Local leaderboard arrays
      let moneyBoard = JSON.parse(localStorage.getItem('moneyBoard') || '[]');
      let deliveryBoard = JSON.parse(localStorage.getItem('deliveryBoard') || '[]');

      moneyBoard.push({ name: username, score });
      deliveryBoard.push({ name: username, deliveries });

      moneyBoard = moneyBoard.sort((a,b) => b.score - a.score).slice(0, 10);
      deliveryBoard = deliveryBoard.sort((a,b) => b.deliveries - a.deliveries).slice(0, 10);

      localStorage.setItem('moneyBoard', JSON.stringify(moneyBoard));
      localStorage.setItem('deliveryBoard', JSON.stringify(deliveryBoard));
    }

    function showLeaderboards() {
      const moneyBoard = JSON.parse(localStorage.getItem('moneyBoard') || '[]');
      const deliveryBoard = JSON.parse(localStorage.getItem('deliveryBoard') || '[]');

      // World money leaderboard
      worldMoneyList.innerHTML = moneyBoard.map((e, i) => `<li>${e.name}: $${e.score}</li>`).join('');
      // World delivery leaderboard
      worldDeliveryList.innerHTML = deliveryBoard.map((e, i) => `<li>${e.name}: ${e.deliveries} deliveries</li>`).join('');

      // Personal bests
      personalMoneyBest.textContent = `$${localStorage.getItem('personalBestMoney') || 0}`;
      personalDeliveriesBest.textContent = `${localStorage.getItem('personalBestDeliveries') || 0} deliveries`;
    }

    function updateMoneyMultiplierDisplay() {
      document.getElementById('moneyMultiplierDisplay').textContent = moneyMultiplier.toFixed(2) + 'x';
    }

    function buyUpgrade(cost) {
      if (score < cost) {
        showUpgradeMessage("Not enough money!");
        return;
      }
      if (cost === 10000 && moneyMultiplier >= 1.10) {
        showUpgradeMessage("10% upgrade already purchased!");
        return;
      }
      if (cost === 100000 && moneyMultiplier >= 1.25) {
        showUpgradeMessage("25% upgrade already purchased!");
        return;
      }

      score -= cost;
      // Save score immediately so player can see updated amount
      updateMoneyMultiplierDisplay();

      if (cost === 10000) {
        moneyMultiplier = Math.max(moneyMultiplier, 1.10);
      } else if (cost === 100000) {
        moneyMultiplier = Math.max(moneyMultiplier, 1.25);
      }
      localStorage.setItem('moneyMultiplier', moneyMultiplier);

      updateMoneyMultiplierDisplay();
      showUpgradeMessage(`Upgrade purchased! Money multiplier is now ${moneyMultiplier.toFixed(2)}x`);
    }

    function showUpgradeMessage(msg) {
      upgradeMessage.textContent = msg;
      setTimeout(() => {
        if (upgradeMessage.textContent === msg) upgradeMessage.textContent = '';
      }, 3000);
    }

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
